# FPV Racing Car
107學年度 無線感測網路協定與應用 期末專題

第19組 龔珮瑜、陳姿佑

## 一、動機
我們選擇做第一人稱視角賽車是希望能夠結合競賽型賽車和遙控賽車的優點，既擁有競賽型賽車的刺激感與臨場感，又能有遙控車的安全性，此外我們還結合了各式感測器，使得我們的第一人稱視角賽車能配有當今進階車種才有的監控和保護功能。

## 二、架構
[![DEMO](https://i9.ytimg.com/vi/D7PEC6-I-ks/mq2.jpg?sqp=CJyci44G&rs=AOn4CLABgZwjSrmELlP_tmkFJvMep7_UQw)](https://www.youtube.com/watch?v=D7PEC6-I-ks&ab_channel=%E9%99%B3%E5%A7%BF%E4%BD%91)

系統分成遙控端和汽車端。汽車端主要由Raspberry Pi控制，裝有多個感測器，包含超音波、電壓和溫度，另外還有攝影機。遙控端有兩個選擇，一個是透過手機APP遙控，另一個是透過賽車方向盤。兩端之間藉由WiFi通訊。
![系統架構圖](https://github.com/zzalice/SportCar/blob/master/%E7%B3%BB%E7%B5%B1%E6%9E%B6%E6%A7%8B%E5%9C%96.png?raw=true)

汽車端的感測器功能包含：
* 超音波裝在車頭，當遇到障礙物會緊急煞車。
* 電壓感測器會偵測電池電壓，推知目前剩餘電量。
* 溫度感測器會監測Raspberry Pi的CPU溫度。
* 攝影機會拍攝道路，模擬第一人稱視角。

而汽車端的控制板有兩個：Raspberry Pi和Arduino。Raspberry Pi會接收控制訊號，依據訊號內容分別送給前輪或Arduino，前輪會控制轉向，而Arduino接收到的訊號是前進、後退的訊號，能夠控制車輪的轉速，此外Arduino還會控制超音波，當超音波偵測到障礙物時，會立即煞車，且限制車子只能後退不能前進，直到不再偵測到障礙物。另外Raspberry Pi會回覆控制端的請求，包含影像串流、電池電壓和CPU溫度。
在汽車端，我們用了兩顆電池供電，一顆供給後輪，另一顆則供給其餘的控制板和感測器，這顆電池還接了一個降壓器，將7.4V轉5V供給Raspberry Pi。
![汽車端架構圖](https://github.com/zzalice/SportCar/blob/master/%E6%B1%BD%E8%BB%8A%E7%AB%AF%E6%9E%B6%E6%A7%8B%E5%9C%96.png)

賽車方向盤連接了另一個Raspberry Pi，這個Raspberry Pi會接收方向盤和腳踏板傳來的訊號，並將訊號透過WiFi送給控制端，另外在方向盤上還有兩個按鈕可以微調轉向的中間值，例如：當使用者想向前走時，卻發現車子一直向左偏，那麼就能按按鈕「R」，讓輪胎向右偏，來導正方向。

APP控制端有全螢幕的串流影像、兩個滑動條(seekbar)控制前進、後退和方向，還有兩個按鈕能矯正轉向。
![APP畫面](https://github.com/zzalice/SportCar/blob/master/%E6%89%8B%E6%A9%9F.png)

## 三、實作
### (一) 無線通訊
我們使用MQTT通訊協定來傳遞資料，訂定不同的主題以區分控制訊號和感測器資訊。
### (二) 賽車方向盤
我們用JoyStick接收方向盤傳來的資訊，再將資訊對應到PWM訊號，也就是透過MQTT送出的車子控制訊號。
 
另外，我們的車子只有前進和後退的踏板，沒有倒退檔，當想要倒退時有兩個情況，一個是當下車子正在前進或是剛剛踩的是前進踏板，那麼必須先讓車子「倒退」，達成煞車後，再踩一次倒退踏板，才能讓車子後退。另一個情況是車子靜止，但是剛剛正在倒車，那麼再踩一次後退，車子會馬上反應。不過當想要讓車子前進時，只需要踩前進踏板，車子會立即向前跑。

### (三) APP控制
APP畫面左方是控制前進、後退的滑動條，右方的控制轉向。只要一移動就會透過MQTT送出對應的PWM數值。

### (四) 影像串流
我們的影像串流用的是Python的picamera，透過Python內建的http.server模組達成簡易的影像串流。
順帶一提，電腦版的畫面是用網頁呈現，HTML檔並未固定放在有HTTP伺服器的裝置上，而是任何需要的裝置，只要擁有這份HTML檔，都能執行，因為檔案內只有HTML、CSS和JS需要解析，包含MQTT也是用JS實作，因此瀏覽器就能處理，不需要一台伺服器。

### (五) 電壓感測器
由電壓感測器連接電池測量電壓數值，利用SPI介面連接Analog-to-Digital Converter (ADC)，轉換成 Raspberry Pi 可讀取數值。定期（10秒）去取得電池電壓，並將 sensor 所得數值標準化成電壓格式，透過 MQTT 將數值傳到控制端及網頁顯示用。

### (六) 溫度感測器
Raspberry Pi內建有一個溫度感測器，我們取用的溫度即為此，透過電腦或APP監控Raspberry Pi的溫度，當溫度過高時，能即時處理，而電腦和APP端能夠接收資料，也是透過MQTT通訊。

### (七) 超音波感測器
超音波感測器由Arduino控制，當偵測到障礙物距離過近，會馬上煞車，且障礙物未移除前，只執行倒車訊號，前進訊號將被忽略。
